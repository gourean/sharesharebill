<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ShareShare Bill</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f1f5f9;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="text-slate-800 h-screen flex flex-col overflow-hidden font-sans">

    <!-- TOAST NOTIFICATION -->
    <div id="toast-container"
        class="fixed top-5 left-1/2 transform -translate-x-1/2 z-[70] pointer-events-none w-full max-w-sm px-4"></div>

    <!-- VIEW: LOGIN (Full Screen) -->
    <section id="view-login" class="absolute inset-0 z-50 bg-slate-50 flex flex-col justify-center items-center p-6">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border border-slate-100">
            <div
                class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm">
                <i class="fa-solid fa-wallet"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2 text-slate-900 tracking-tight">ShareShare Bill</h1>
            <p class="text-slate-500 mb-8">Effortless group expense tracking.</p>

            <input type="email" id="login-email"
                class="w-full bg-slate-50 border border-slate-300 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                placeholder="Email">
            <input type="password" id="login-pass"
                class="w-full bg-slate-50 border border-slate-300 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                placeholder="Password">

            <button id="btn-login"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl transition shadow-lg shadow-indigo-200 active:scale-[0.98]">
                Login
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 hidden"></p>
            <p class="text-xs text-slate-400 mt-6">Connected to Firebase</p>
        </div>
    </section>

    <!-- MAIN APP LAYOUT -->
    <div id="app-layout" class="flex h-full hidden">

        <!-- SIDEBAR -->
        <aside id="view-dashboard"
            class="w-full md:w-96 bg-white border-r border-slate-200 flex flex-col z-10 shadow-lg md:shadow-none absolute md:relative inset-0 md:inset-auto">
            <header class="bg-white px-6 py-4 flex justify-between items-center border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm"><i
                            class="fa-solid fa-wallet"></i></div>
                    <h2 class="text-xl font-bold text-slate-800">My Trips</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.app.openModal('modal-settings')"
                        class="text-slate-400 hover:text-indigo-600 text-sm transition p-2" title="Settings">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <button id="btn-logout" class="text-slate-400 hover:text-red-500 text-sm transition p-2"
                        title="Logout">
                        <i class="fa-solid fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <div id="trips-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                <div class="text-center text-slate-400 mt-10">Loading trips...</div>
            </div>

            <div class="p-4 bg-white border-t border-slate-100">
                <button onclick="window.app.openCreateTripModal()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl shadow-md transition active:scale-[0.98] flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus"></i> New Trip
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main id="view-trip"
            class="flex-1 bg-slate-100 flex flex-col relative hidden md:flex w-full absolute md:relative inset-0 z-20 md:z-0">

            <!-- Trip Header -->
            <div
                class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm sticky top-0 z-20">
                <div class="flex items-center gap-4">
                    <button onclick="window.app.navigateTo('view-dashboard')"
                        class="md:hidden text-slate-500 hover:text-slate-800"><i
                            class="fa-solid fa-arrow-left fa-lg"></i></button>
                    <div>
                        <h2 id="trip-title" class="text-2xl font-bold text-slate-800 leading-tight">Select a Trip</h2>
                        <div class="flex items-center gap-2 text-sm text-slate-500">
                            <span id="trip-base-currency"
                                class="bg-slate-200 px-2 py-0.5 rounded text-xs font-mono font-bold text-slate-600">---</span>
                            <span id="trip-member-count">0 Members</span>
                            <button onclick="window.app.openModal('modal-members')"
                                class="text-indigo-600 hover:text-indigo-800 text-xs font-bold ml-2 underline">Manage</button>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-slate-400 uppercase font-bold tracking-wider">Total Spent</p>
                    <p id="trip-total-spent" class="text-xl font-bold text-indigo-600">0.00</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex px-6 bg-white border-b border-slate-200">
                <button onclick="window.app.switchTab('expenses')" id="tab-btn-expenses"
                    class="px-6 py-3 font-medium text-sm border-b-2 border-indigo-600 text-indigo-600 transition">Expenses</button>
                <button onclick="window.app.switchTab('settle')" id="tab-btn-settle"
                    class="px-6 py-3 font-medium text-sm border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition">Settle
                    Up</button>
                <button onclick="window.app.switchTab('history')" id="tab-btn-history"
                    class="px-6 py-3 font-medium text-sm border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition">History</button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-hidden relative">

                <!-- Tab: Expenses -->
                <div id="tab-expenses" class="h-full overflow-y-auto p-4 pb-24 md:pb-6 space-y-3">
                    <div class="text-center text-slate-400 mt-10">Select a trip to view expenses</div>
                </div>

                <!-- Tab: Settle -->
                <div id="tab-settle" class="h-full overflow-y-auto p-4 pb-24 md:pb-6 space-y-6 hidden">

                    <!-- Settlement Controls -->
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <i class="fa-solid fa-scale-balanced text-indigo-500"></i> Settlement Plan
                            </h3>
                            <div class="flex items-center gap-2">
                                <span
                                    class="text-xs font-bold text-slate-500 text-right leading-tight">Consolidate<br>Currency</span>
                                <button onclick="window.app.toggleConsolidation()" id="btn-consolidate"
                                    class="w-10 h-6 rounded-full bg-slate-300 relative transition-colors duration-200">
                                    <div
                                        class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 shadow transition-transform duration-200 transform">
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div id="consolidation-options"
                            class="hidden mb-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <label class="text-xs font-bold text-slate-400 uppercase block mb-1">Calculate everything
                                in:</label>
                            <select id="settle-currency-select" onchange="window.app.renderSettlement()"
                                class="w-full bg-white border border-slate-200 rounded p-2 text-sm font-mono"></select>
                            <div class="flex justify-between mt-2">
                                <p id="rates-source-label" class="text-[10px] text-slate-400 text-right">Source: Offline
                                    Mock Data</p>
                            </div>
                        </div>

                        <div id="settlement-plan" class="space-y-3"></div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4 text-xs uppercase tracking-wide">By Category</h3>
                            <div class="h-48 relative"><canvas id="chart-categories"></canvas></div>
                        </div>
                        <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <h3 class="font-bold text-slate-800 mb-4 text-xs uppercase tracking-wide">By Payer</h3>
                            <div class="h-48 relative"><canvas id="chart-payers"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- Tab: History -->
                <div id="tab-history" class="h-full overflow-y-auto p-4 pb-24 md:pb-6 space-y-3 hidden">
                    <div class="text-center text-slate-400 mt-10">No settlement history yet.</div>
                </div>

                <!-- FAB: Added 'bottom-24' for mobile (Android Chrome bar avoidance) and 'md:bottom-6' for desktop -->
                <button onclick="window.app.openModal('modal-add-expense')"
                    class="absolute bottom-24 md:bottom-6 right-6 h-14 w-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg shadow-indigo-300 flex items-center justify-center text-2xl z-30 transition transform hover:scale-110 active:scale-95">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- MODALs (Keep same structure, just IDs referenced in JS) -->
    <!-- Modal: Confirmation -->
    <div id="modal-confirm"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 text-center slide-in">
            <div
                class="w-12 h-12 rounded-full bg-red-100 text-red-500 mx-auto flex items-center justify-center text-xl mb-4">
                <i class="fa-solid fa-triangle-exclamation"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Are you sure?</h3>
            <p id="confirm-message" class="text-slate-500 text-sm mb-6">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="window.app.closeModals()"
                    class="flex-1 py-2.5 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200">Cancel</button>
                <button onclick="window.app.executeConfirm()"
                    class="flex-1 py-2.5 rounded-xl font-bold text-white bg-red-500 hover:bg-red-600 shadow-md">Yes,
                    Delete</button>
            </div>
        </div>
    </div>

    <!-- Modal: Create Trip -->
    <div id="modal-create-trip"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden slide-in">
            <div class="px-6 py-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 id="create-trip-title" class="font-bold text-lg text-slate-800">Start New Trip</h3>
                <button onclick="window.app.closeModals()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Trip Name</label><input type="text"
                        id="new-trip-name" class="w-full border rounded-lg px-3 py-2 outline-none"></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Base Currency</label><select
                        id="new-trip-currency" class="w-full border rounded-lg px-3 py-2 bg-white"></select></div>
                <div><label class="block text-sm font-bold text-slate-700 mb-1">Members</label><input type="text"
                        id="new-trip-members" class="w-full border rounded-lg px-3 py-2 outline-none"
                        placeholder="Alice, Bob..."></div>
                <button onclick="window.app.saveTrip()" id="create-trip-btn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl mt-2 shadow-md">Create
                    Trip</button>
            </div>
        </div>
    </div>

    <!-- Modal: Manage Members -->
    <div id="modal-members"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden slide-in">
            <div class="px-6 py-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Manage Members</h3>
                <button onclick="window.app.closeModals()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-slate-50 border-b">
                <div class="flex gap-2">
                    <input type="text" id="add-member-input" class="flex-1 border rounded-lg px-3 py-2 text-sm"
                        placeholder="Name or email to invite">
                    <button onclick="window.app.addMember()"
                        class="bg-indigo-600 text-white px-4 rounded-lg text-sm font-bold hover:bg-indigo-700">Add</button>
                </div>
            </div>
            <div id="members-list-manage" class="p-0 max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="modal-settings"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden slide-in">
            <div class="px-6 py-4 border-b bg-slate-50 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Settings</h3>
                <button onclick="window.app.closeModals()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">Display Name</label>
                    <input type="text" id="setting-display-name" class="w-full border rounded-lg px-3 py-2 outline-none"
                        placeholder="Your Name">
                    <p class="text-xs text-slate-400 mt-1">This name will be shown to your trip members instead of
                        your
                        email.</p>
                </div>
                <button onclick="window.app.saveSettings()"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-md">Save
                    Settings</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Expense -->
    <div id="modal-add-expense"
        class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-md shadow-2xl overflow-hidden slide-in max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="px-6 py-4 border-b bg-slate-50 flex justify-between items-center sticky top-0 z-10">
                <h3 id="expense-modal-title" class="font-bold text-lg text-slate-800">Add Expense</h3>
                <button onclick="window.app.closeModals()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Description</label><input
                        type="text" id="exp-desc" class="w-full border rounded-xl px-3 py-3 outline-none"
                        placeholder="Dinner"></div>
                <div class="flex gap-3">
                    <div class="flex-1"><label
                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Amount</label><input
                            type="number" id="exp-amount" step="0.01"
                            class="w-full border rounded-xl px-3 py-3 outline-none text-xl font-bold"
                            placeholder="0.00"></div>
                    <div class="w-28"><label
                            class="block text-xs font-bold text-slate-500 uppercase mb-1">Currency</label><select
                            id="exp-currency"
                            class="w-full border rounded-xl px-2 py-3 bg-white font-mono h-[54px] text-sm"></select>
                    </div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Paid By</label><select
                        id="exp-payer" class="w-full border rounded-xl px-3 py-3 bg-white"></select></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Category</label>
                    <div class="grid grid-cols-3 gap-3" id="category-grid"></div><input type="hidden" id="exp-category"
                        value="Food">
                </div>
                <!-- Split Options -->
                <div>
                    <button type="button" onclick="document.getElementById('split-options').classList.toggle('hidden')"
                        class="w-full py-3 rounded-xl border border-dashed border-indigo-300 text-indigo-600 font-bold bg-indigo-50 hover:bg-indigo-100 flex items-center justify-center gap-2 transition mb-4">
                        <i class="fa-solid fa-sliders"></i> More Options (Split)
                    </button>
                    <div id="split-options" class="hidden mt-3 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div class="mb-4">
                            <!-- Hidden Checkbox for Logic Compatibility -->
                            <input type="checkbox" id="exp-not-shared" class="hidden">

                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Split Method</label>
                            <div class="flex bg-white rounded-lg p-1 border border-slate-200 mb-3">
                                <button type="button" onclick="window.app.setSplitType('equal')" id="btn-split-equal"
                                    class="flex-1 py-1.5 text-xs font-bold rounded bg-indigo-100 text-indigo-700">Equal</button>
                                <button type="button" onclick="window.app.setSplitType('exact')" id="btn-split-exact"
                                    class="flex-1 py-1.5 text-xs font-bold rounded text-slate-500 hover:bg-slate-50">Exact</button>
                                <button type="button" onclick="window.app.setSplitType('personal')"
                                    id="btn-split-personal"
                                    class="flex-1 py-1.5 text-xs font-bold rounded text-slate-500 hover:bg-slate-50">Personal</button>
                            </div>

                            <div id="split-logic-container">
                                <div id="split-members-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                                <p id="split-validation-msg" class="text-xs text-red-500 mt-2 hidden font-bold"></p>
                            </div>
                            <!-- Helper text for personal mode -->
                            <p id="personal-mode-msg" class="text-xs text-slate-400 italic text-center hidden">This
                                expense will not be shared.</p>
                        </div>
                    </div>
                    <button onclick="window.app.saveExpense()" id="expense-modal-btn"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-md">Save
                        Expense</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Record Payment (Moved out) -->
    <div id="modal-settle-up"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl p-6 slide-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg text-slate-800">Record Payment</h3>
                <button onclick="window.app.closeModals()" class="text-slate-400 hover:text-slate-600"><i
                        class="fa-solid fa-xmark fa-lg"></i></button>
            </div>

            <div class="flex items-center gap-3 mb-6 bg-slate-50 p-4 rounded-xl border border-slate-100">
                <div class="text-center flex-1">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Payer</p>
                    <p class="font-bold text-slate-800 truncate" id="settle-from-name">Alice</p>
                </div>
                <i class="fa-solid fa-arrow-right text-slate-300"></i>
                <div class="text-center flex-1">
                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Payee</p>
                    <p class="font-bold text-slate-800 truncate" id="settle-to-name">Bob</p>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Amount Paid</label>
                <div class="flex items-center gap-2">
                    <span class="text-xl font-bold text-slate-400" id="settle-currency-display">USD</span>
                    <input type="number" id="settle-amount" step="0.01"
                        class="w-full text-3xl font-bold text-slate-800 border-b-2 border-slate-200 focus:border-indigo-600 outline-none hover:border-slate-300 transition py-2"
                        placeholder="0.00">
                </div>
            </div>

            <button onclick="window.app.saveSettlement()"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-md shadow-green-200 transition active:scale-[0.98]">
                <i class="fa-solid fa-check mr-2"></i> Record Payment
            </button>
        </div>
    </div>

    <!-- MODULE SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        // Added getDocs import for deletion query
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query, where, orderBy, serverTimestamp, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAky26IbqI1_05VIIJdp0VxQ0uH7AymnDs",
            authDomain: "shareshare-bill.firebaseapp.com",
            projectId: "shareshare-bill",
            storageBucket: "shareshare-bill.firebasestorage.app",
            messagingSenderId: "1089003185218",
            appId: "1:1089003185218:web:ba546dc2505c9f6e4179db"
        };

        // INIT FIREBASE
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL VARIABLES (Window Scope) ---
        // Enhanced Rates List
        let RATES = {
            'USD': 1.0, 'EUR': 0.95, 'GBP': 0.79, 'JPY': 150.0, 'CNY': 7.15,
            'MYR': 4.45, 'SGD': 1.35, 'AUD': 1.52, 'CAD': 1.36, 'CHF': 0.88,
            'INR': 83.3, 'HKD': 7.82, 'NZD': 1.63, 'THB': 35.5, 'IDR': 15500,
            'VND': 24500, 'PHP': 55.8, 'KRW': 1300, 'TWD': 31.5, 'BDT': 109.5,
            'LKR': 324.0, 'PKR': 278.5, 'NPR': 133.2
        };
        let CURRENCY_CODES = Object.keys(RATES).sort();
        let USING_LIVE_RATES = false;
        const DEFAULT_API_KEY = 'fca_live_yHV7zero5t3xM8wjgSS4tWx6ELu5QV6CcaaZjRgi';

        const CATEGORIES = [
            { id: 'Food', icon: 'fa-utensils', color: 'bg-orange-100 text-orange-600 border-orange-200' },
            { id: 'Transport', icon: 'fa-bus', color: 'bg-blue-100 text-blue-600 border-blue-200' },
            { id: 'Stay', icon: 'fa-bed', color: 'bg-purple-100 text-purple-600 border-purple-200' },
            { id: 'Flight', icon: 'fa-plane', color: 'bg-sky-100 text-sky-600 border-sky-200' },
            { id: 'Ent.', icon: 'fa-ticket', color: 'bg-pink-100 text-pink-600 border-pink-200' },
            { id: 'Other', icon: 'fa-bag-shopping', color: 'bg-gray-100 text-gray-600 border-gray-200' },
        ];

        // LOCAL STATE (Synced with Firebase)
        let localTrips = [];
        let localExpenses = [];
        let userProfiles = {}; // Cache for { email: displayName }
        let currentTripId = null;
        let currentUser = null;
        let unsubscribeTrips = null;
        let unsubscribeExpenses = null;
        let unsubscribeUsers = null;
        let charts = { cat: null, payer: null };
        let state = { consolidate: false };
        let pendingAction = null;
        let editingExpenseId = null;
        let editingTripId = null;
        let editingSettlementId = null;
        let currentSplitType = 'equal'; // equal, exact

        // --- AUTH LISTENER ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user.email;
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('app-layout').classList.remove('hidden');
                window.app.setupRealtimeListeners(user);
                window.app.listenToUsers();
                window.app.refreshCurrencyDropdowns();
                if (window.innerWidth >= 768) {
                    // Try open first trip if exists after data loads (handled in snapshot)
                }
            } else {
                currentUser = null;
                document.getElementById('view-login').classList.remove('hidden');
                document.getElementById('app-layout').classList.add('hidden');
                if (unsubscribeTrips) unsubscribeTrips();
                if (unsubscribeExpenses) unsubscribeExpenses();
                if (unsubscribeUsers) unsubscribeUsers();
            }
        });

        // --- WINDOW APP CONTROLLER ---
        window.app = {
            // AUTH
            login: async () => {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;
                const errorText = document.getElementById('login-error');
                const btn = document.getElementById('btn-login');

                if (!email || !pass) {
                    errorText.innerText = "Please fill in all fields";
                    errorText.classList.remove('hidden');
                    return;
                }

                try {
                    btn.innerText = "Signing in...";
                    await signInWithEmailAndPassword(auth, email, pass);
                    // Listener handles transition
                } catch (error) {
                    errorText.innerText = "Error: " + error.message;
                    errorText.classList.remove('hidden');
                    btn.innerText = "Login";
                }
            },
            logout: async () => {
                await signOut(auth);
            },

            // FIRESTORE LISTENERS
            setupRealtimeListeners: (user) => {
                // 1. Listen to Trips
                // 1. Listen to Trips
                // MODIFIED: Filter by member array containing current user's email
                // REMOVED orderBy("createdAt", "desc") to avoid composite index requirements with array-contains
                const q = query(collection(db, "trips"), where("members", "array-contains", user.email));

                unsubscribeTrips = onSnapshot(q, (snapshot) => {
                    localTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Client-side sorting (Newest first)
                    localTrips.sort((a, b) => {
                        const dateA = a.createdAt ? a.createdAt.seconds : 0;
                        const dateB = b.createdAt ? b.createdAt.seconds : 0;
                        return dateB - dateA;
                    });

                    window.app.renderTripList();
                    // On desktop, auto-open first trip if exists after data loads (handled in snapshot)
                    if (window.innerWidth >= 768 && !currentTripId && localTrips.length > 0) {
                        window.app.openTrip(localTrips[0].id);
                    }
                });
            },
            listenToExpenses: (tripId) => {
                if (unsubscribeExpenses) unsubscribeExpenses();
                // 2. Listen to Expenses for specific trip
                // REMOVED orderBy("date", "desc") to fix missing index error
                const q = query(collection(db, "expenses"), where("tripId", "==", tripId));
                unsubscribeExpenses = onSnapshot(q, (snapshot) => {
                    localExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Client-side sorting
                    localExpenses.sort((a, b) => {
                        const dateA = a.date ? a.date.seconds : 0;
                        const dateB = b.date ? b.date.seconds : 0;
                        return dateB - dateA; // DESC
                    });

                    window.app.renderExpenses();
                    window.app.updateHeaderStats();
                    if (!document.getElementById('tab-settle').classList.contains('hidden')) {
                        window.app.renderSettlement();
                    }
                });
            },

            listenToUsers: () => {
                // Listen to all users for name resolution (Optimized: in production, should only listen to relevant users)
                // For this scale, listening to "users" collection is fine.
                const q = collection(db, "users");
                unsubscribeUsers = onSnapshot(q, (snapshot) => {
                    userProfiles = {};
                    snapshot.docs.forEach(doc => {
                        userProfiles[doc.id] = doc.data().displayName;
                    });
                    // Refresh UIs
                    window.app.renderTripList();
                    if (currentTripId) {
                        window.app.renderManageMembers();
                        window.app.renderExpenses();
                        if (!document.getElementById('tab-settle').classList.contains('hidden')) {
                            window.app.renderSettlement();
                        }
                    }
                });
            },

            // DATA OPERATIONS (WRITE)
            saveTrip: async () => {
                const name = document.getElementById('new-trip-name').value;
                const currency = document.getElementById('new-trip-currency').value;
                const membersRaw = document.getElementById('new-trip-members').value;
                if (!name) return ui.showToast('Trip name is required', 'error');

                const members = membersRaw.split(',').map(m => m.trim()).filter(m => m);
                if (!members.includes(currentUser)) members.unshift(currentUser); // Add admin

                try {
                    if (editingTripId) {
                        // Update existing trip
                        await updateDoc(doc(db, "trips", editingTripId), {
                            name, currency, members
                        });
                        ui.showToast('Trip updated!');
                    } else {
                        // Create new trip
                        const docRef = await addDoc(collection(db, "trips"), {
                            name, currency, members,
                            createdBy: currentUser,
                            createdAt: serverTimestamp()
                        });
                        ui.showToast('Trip created!');
                        window.app.openTrip(docRef.id);
                    }
                    window.app.closeModals();
                } catch (e) {
                    ui.showToast("Error saving trip: " + e.message, 'error');
                }
            },
            saveExpense: async () => {
                const desc = document.getElementById('exp-desc').value;
                const amount = parseFloat(document.getElementById('exp-amount').value);
                const currency = document.getElementById('exp-currency').value;
                const payer = document.getElementById('exp-payer').value;
                const category = document.getElementById('exp-category').value;
                const notShared = document.getElementById('exp-not-shared').checked;

                // SPLIT VALIDATION
                let splitDetails = {};
                let splitType = currentSplitType;

                if (notShared) {
                    splitType = 'personal';
                } else if (splitType === 'exact') {
                    const inputs = document.querySelectorAll('.split-input');
                    let sum = 0;
                    inputs.forEach(inp => {
                        const val = parseFloat(inp.value) || 0;
                        splitDetails[inp.dataset.member] = val;
                        sum += val;
                    });
                    if (Math.abs(sum - amount) > 0.05) {
                        const msg = document.getElementById('split-validation-msg');
                        msg.innerText = `Total split (${sum.toFixed(2)}) does not match expense amount (${amount.toFixed(2)})`;
                        msg.classList.remove('hidden');
                        return;
                    }
                }

                if (!desc || isNaN(amount) || amount <= 0) return ui.showToast('Invalid details', 'error');

                const expenseData = {
                    tripId: currentTripId,
                    desc, amount, currency, payer, category, notShared,
                    splitType, splitDetails,
                    date: serverTimestamp() // Firestore timestamp
                };

                try {
                    if (editingExpenseId) {
                        // Update
                        const ref = doc(db, "expenses", editingExpenseId);
                        await updateDoc(ref, expenseData);
                        ui.showToast('Expense updated');
                    } else {
                        // Create
                        await addDoc(collection(db, "expenses"), expenseData);
                        ui.showToast('Expense saved');
                    }
                    window.app.closeModals();
                } catch (e) {
                    ui.showToast("Error saving: " + e.message, 'error');
                }
            },
            requestDeleteTrip: (e, id) => {
                e.stopPropagation();
                pendingAction = async () => {
                    try {
                        // 1. Delete associated expenses first (Client-side Cascade)
                        const expensesQuery = query(collection(db, "expenses"), where("tripId", "==", id));
                        const expensesSnapshot = await getDocs(expensesQuery);

                        const deletePromises = expensesSnapshot.docs.map(d => deleteDoc(doc(db, "expenses", d.id)));
                        await Promise.all(deletePromises);

                        // 2. Delete trip doc
                        await deleteDoc(doc(db, "trips", id));

                        if (currentTripId === id) {
                            currentTripId = null;
                            document.getElementById('trip-title').innerText = "Select a Trip";
                            document.getElementById('tab-expenses').innerHTML = '<div class="text-center text-slate-400 mt-10">Select a trip</div>';
                            if (window.innerWidth < 768) window.app.navigateTo('view-dashboard');
                        }
                        ui.showToast('Trip and all expenses deleted');
                    } catch (error) {
                        console.error("Error deleting trip:", error);
                        ui.showToast("Error deleting trip", "error");
                    }
                };
                document.getElementById('confirm-message').innerText = "Delete this trip and all its expenses?";
                document.getElementById('modal-confirm').classList.remove('hidden');
            },
            requestDeleteExpense: (id, type = 'expense') => {
                pendingAction = async () => {
                    await deleteDoc(doc(db, "expenses", id));
                    ui.showToast(`${type === 'settlement' ? 'Settlement' : 'Expense'} deleted`);
                };
                document.getElementById('confirm-message').innerText = type === 'settlement' ? "Delete this settlement?" : "Delete this expense?";
                document.getElementById('modal-confirm').classList.remove('hidden');
            },
            executeConfirm: () => {
                if (pendingAction) pendingAction();
                pendingAction = null;
                window.app.closeModals();
            },
            addMember: async () => {
                const input = document.getElementById('add-member-input');
                const name = input.value.trim();
                if (!name) return;
                const trip = localTrips.find(t => t.id === currentTripId);
                if (!trip.members.includes(name)) {
                    const newMembers = [...trip.members, name];
                    await updateDoc(doc(db, "trips", currentTripId), { members: newMembers });
                    input.value = '';
                    window.app.renderManageMembers(); // Local update visual immediate
                    ui.showToast(`${name} added!`);
                }
            },
            removeMember: async (name) => {
                const trip = localTrips.find(t => t.id === currentTripId);
                // Protect Owner
                if (name === trip.createdBy || name === window.app.getDisplayName(trip.createdBy)) {
                    return ui.showToast("Cannot remove the trip owner", "error");
                }
                const newMembers = trip.members.filter(m => m !== name);
                await updateDoc(doc(db, "trips", currentTripId), { members: newMembers });
                window.app.renderManageMembers();
                ui.showToast(`${name} removed.`);
            },
            saveSettings: async () => {
                const name = document.getElementById('setting-display-name').value.trim();
                if (!name) return;
                try {
                    await setDoc(doc(db, "users", currentUser), { displayName: name }, { merge: true });
                    ui.showToast('Profile updated!');
                    window.app.closeModals();
                } catch (e) {
                    ui.showToast("Error updating profile", "error");
                }
            },
            getDisplayName: (emailOrName) => {
                if (!emailOrName) return 'Unknown';
                if (emailOrName === currentUser) return 'You';
                if (emailOrName.includes('@')) {
                    return (userProfiles && userProfiles[emailOrName]) || emailOrName;
                }
                return emailOrName;
            },

            // --- VIEW LOGIC ---
            navigateTo: (view) => {
                if (window.innerWidth < 768) {
                    if (view === 'view-dashboard') {
                        document.getElementById('view-dashboard').classList.remove('hidden');
                        document.getElementById('view-trip').classList.add('hidden');
                    } else if (view === 'view-trip') {
                        document.getElementById('view-dashboard').classList.add('hidden');
                        document.getElementById('view-trip').classList.remove('hidden');
                    }
                }
            },
            renderTripList: () => {
                const container = document.getElementById('trips-list');
                container.innerHTML = '';
                localTrips.forEach(trip => {
                    const isActive = trip.id === currentTripId;
                    const el = document.createElement('div');
                    el.className = `p-4 rounded-xl shadow-sm border transition cursor-pointer flex justify-between items-center group relative overflow-hidden ${isActive ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:border-indigo-300'}`;
                    el.onclick = () => window.app.openTrip(trip.id);
                    el.innerHTML = `
                        <div class="flex-1">
                            <h3 class="font-bold text-slate-800 text-base ${isActive ? 'text-indigo-700' : ''}">${trip.name}</h3>
                            <p class="text-xs text-slate-500 mt-1">${trip.members.length} people • ${trip.currency}</p>
                        </div>
                        <div class="flex items-center gap-2 relative z-10">
                            ${trip.createdBy === currentUser ?
                            `<button onclick="event.stopPropagation(); window.app.openCreateTripModal('${trip.id}')" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-400 hover:bg-indigo-100 hover:text-indigo-600 transition active:bg-indigo-200"><i class="fa-solid fa-pen"></i></button>
                                 <button onclick="window.app.requestDeleteTrip(event, '${trip.id}')" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-300 hover:bg-red-100 hover:text-red-500 transition active:bg-red-200"><i class="fa-solid fa-trash-can"></i></button>`
                            : ''}
                        </div>
                    `;
                    container.appendChild(el);
                });
            },
            openTrip: (id) => {
                currentTripId = id;
                window.app.renderTripList();
                const trip = localTrips.find(t => t.id === id);
                if (!trip) return;

                document.getElementById('trip-title').innerText = trip.name;
                document.getElementById('trip-base-currency').innerText = trip.currency;

                // Start listening to expenses for this trip
                window.app.listenToExpenses(id);

                window.app.navigateTo('view-trip');
                window.app.switchTab('expenses');
            },
            updateHeaderStats: () => {
                const trip = localTrips.find(t => t.id === currentTripId);
                if (!trip) return;
                document.getElementById('trip-member-count').innerText = `${trip.members.length} Members`;
                let total = 0;
                localExpenses.filter(e => !e.isSettlement).forEach(e => total += util.convert(e.amount, e.currency, trip.currency));
                document.getElementById('trip-total-spent').innerText = `${trip.currency} ${total.toFixed(2)}`;
            },
            renderExpenses: () => {
                const list = document.getElementById('tab-expenses');
                const expenses = localExpenses.filter(e => !e.isSettlement); // Hide settlements
                if (expenses.length === 0) {
                    list.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-300"><i class="fa-solid fa-receipt text-5xl mb-3"></i><p>No expenses yet</p></div>`;
                    return;
                }
                list.innerHTML = '';
                expenses.forEach(exp => {
                    const catObj = CATEGORIES.find(c => c.id === exp.category) || CATEGORIES[5];
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-sm flex items-center gap-4 border border-slate-200 group relative';
                    el.innerHTML = `
                        <div class="h-10 w-10 rounded-full ${catObj.color} flex items-center justify-center shrink-0 border border-white shadow-sm"><i class="fa-solid ${catObj.icon}"></i></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 truncate">${exp.desc}</h4>
                            <p class="text-xs text-slate-500 truncate mt-0.5"><span class="font-semibold text-slate-700">${window.app.getDisplayName(exp.payer)}</span> • ${exp.notShared ? '<span class="text-red-500 font-bold">Personal</span>' : 'Shared'}</p>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <div class="font-bold text-slate-800 text-sm mb-1">${exp.currency} ${exp.amount.toFixed(2)}</div>
                            <!-- Fix: Static flow for ALL screens. Desktop just hides opacity. -->
                            <div class="flex gap-2 mt-1 transition md:opacity-0 md:group-hover:opacity-100 opacity-100">
                                <button onclick="window.app.editExpense('${exp.id}')" class="text-slate-400 md:text-slate-300 hover:text-indigo-600 text-sm p-3 bg-slate-50 md:bg-transparent rounded-full md:rounded-none shadow-sm md:shadow-none"><i class="fa-solid fa-pencil"></i></button>
                                <button onclick="window.app.requestDeleteExpense('${exp.id}')" class="text-slate-400 md:text-slate-300 hover:text-red-500 text-sm p-3 bg-slate-50 md:bg-transparent rounded-full md:rounded-none shadow-sm md:shadow-none"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                });
            },
            renderHistory: () => {
                const list = document.getElementById('tab-history');
                const settlements = localExpenses.filter(e => e.isSettlement);
                if (settlements.length === 0) {
                    list.innerHTML = '<div class="flex flex-col items-center justify-center h-64 text-slate-300"><i class="fa-solid fa-handshake text-5xl mb-3"></i><p>No settlement history</p></div>';
                    return;
                }
                list.innerHTML = '';
                settlements.forEach(pay => {
                    const payee = Object.keys(pay.splitDetails)[0]; // Logic: exact split to 1 person
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-sm flex items-center gap-4 border border-slate-200 group relative';
                    el.innerHTML = `
                        <div class="h-10 w-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center shrink-0 border border-white shadow-sm"><i class="fa-solid fa-money-bill-transfer"></i></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-slate-800 truncate">Payment</h4>
                            <p class="text-xs text-slate-500 truncate mt-0.5"><span class="font-semibold text-slate-700">${window.app.getDisplayName(pay.payer)}</span> paid <span class="font-semibold text-slate-700">${window.app.getDisplayName(payee)}</span></p>
                        </div>
                         <div class="text-right flex flex-col items-end">
                            <div class="font-bold text-green-600 text-sm mb-1">${pay.currency} ${pay.amount.toFixed(2)}</div>
                            <div class="flex gap-2 mt-1 transition md:opacity-0 md:group-hover:opacity-100 opacity-100">
                                <button onclick="window.app.editSettlement('${pay.id}')" class="text-slate-400 md:text-slate-300 hover:text-indigo-600 text-sm p-3 bg-slate-50 md:bg-transparent rounded-full md:rounded-none shadow-sm md:shadow-none"><i class="fa-solid fa-pencil"></i></button>
                                <button onclick="window.app.requestDeleteExpense('${pay.id}', 'settlement')" class="text-slate-400 md:text-slate-300 hover:text-red-500 text-sm p-3 bg-slate-50 md:bg-transparent rounded-full md:rounded-none shadow-sm md:shadow-none"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                });
            },

            // SETTLEMENT ACTIONS
            pendingSettle: null,
            openSettleModal: (from, to, amount, curr) => {
                // Prevent settling if not logged in user logic? Optional.
                window.app.pendingSettle = { from, to, amount, curr };
                document.getElementById('settle-from-name').innerText = window.app.getDisplayName(from);
                document.getElementById('settle-to-name').innerText = window.app.getDisplayName(to);
                document.getElementById('settle-currency-display').innerText = curr;
                document.getElementById('settle-amount').value = amount.toFixed(2);
                window.app.openModal('modal-settle-up');
            },
            editSettlement: (id) => {
                const pay = localExpenses.find(e => e.id === id);
                if (!pay) return;
                editingSettlementId = id;
                // Reconstruct pendingSettle
                const payee = Object.keys(pay.splitDetails)[0];
                window.app.pendingSettle = { from: pay.payer, to: payee, amount: pay.amount, curr: pay.currency };
                document.getElementById('settle-from-name').innerText = window.app.getDisplayName(pay.payer);
                document.getElementById('settle-to-name').innerText = window.app.getDisplayName(payee);
                document.getElementById('settle-currency-display').innerText = pay.currency;
                document.getElementById('settle-amount').value = pay.amount.toFixed(2);
                window.app.openModal('modal-settle-up');
            },
            saveSettlement: async () => {
                const amt = parseFloat(document.getElementById('settle-amount').value);
                if (!window.app.pendingSettle || isNaN(amt) || amt <= 0) return;

                try {
                    const expenseData = {
                        tripId: currentTripId,
                        desc: 'Settlement Payment',
                        amount: amt,
                        currency: window.app.pendingSettle.curr,
                        payer: window.app.pendingSettle.from,
                        category: 'Settlement',
                        notShared: false,
                        isSettlement: true,
                        splitType: 'exact',
                        splitDetails: { [window.app.pendingSettle.to]: amt }, // Payee consumes the full amount
                        date: serverTimestamp()
                    };
                    if (editingSettlementId) {
                        await updateDoc(doc(db, "expenses", editingSettlementId), expenseData);
                        ui.showToast('Payment updated!');
                    } else {
                        await addDoc(collection(db, "expenses"), expenseData);
                        ui.showToast('Payment recorded!');
                    }
                    window.app.closeModals();
                    // Auto switch to history?
                    window.app.switchTab('history');
                } catch (e) {
                    ui.showToast('Error saving: ' + e.message, 'error');
                }
            },
            renderManageMembers: () => {
                if (!currentTripId) return;
                const trip = localTrips.find(t => t.id === currentTripId);
                if (!trip) return;
                const list = document.getElementById('members-list-manage');
                list.innerHTML = '';
                trip.members.forEach(m => {
                    const div = document.createElement('div');
                    const isEmail = m.includes('@');
                    div.className = 'flex justify-between items-center p-3 border-b border-slate-100 last:border-0';
                    div.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full ${isEmail ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-500'} flex items-center justify-center text-xs font-bold">
                                ${isEmail ? '<i class="fa-solid fa-user-check"></i>' : m.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-slate-700">${window.app.getDisplayName(m)}</span>
                                ${isEmail ? '<span class="text-[10px] text-slate-400">Registered User</span>' : ''}
                            </div>
                        </div>
                        ${m !== currentUser ? `<button onclick="window.app.removeMember('${m}')" class="text-red-400 hover:text-red-600 text-xs"><i class="fa-solid fa-trash"></i></button>` : ''}
                    `;
                    list.appendChild(div);
                });
            },

            // --- CURRENCY API & UI ---
            refreshCurrencyDropdowns: () => {
                const newTripCurr = document.getElementById('new-trip-currency');
                const settleCurr = document.getElementById('settle-currency-select');
                newTripCurr.innerHTML = ''; settleCurr.innerHTML = '';
                CURRENCY_CODES.forEach(c => {
                    newTripCurr.add(new Option(c, c));
                    settleCurr.add(new Option(c, c));
                });
            },
            toggleConsolidation: async () => {
                state.consolidate = !state.consolidate;
                const btn = document.getElementById('btn-consolidate');
                const knob = btn.firstElementChild;
                const options = document.getElementById('consolidation-options');
                if (state.consolidate) {
                    btn.classList.replace('bg-slate-300', 'bg-indigo-600');
                    knob.classList.add('translate-x-4');
                    options.classList.remove('hidden');
                    if (!USING_LIVE_RATES) await window.app.fetchExchangeRates();

                    // Set Default to MYR if not set
                    const sel = document.getElementById('settle-currency-select');
                    if (sel && sel.value !== 'MYR') sel.value = 'MYR';

                } else {
                    btn.classList.replace('bg-indigo-600', 'bg-slate-300');
                    knob.classList.remove('translate-x-4');
                    options.classList.add('hidden');
                }
                window.app.renderSettlement();
            },
            fetchExchangeRates: async () => {
                try {
                    ui.showToast('Fetching live rates...', 'info');
                    const response = await fetch(`https://api.freecurrencyapi.com/v1/latest?apikey=${DEFAULT_API_KEY}`);
                    if (!response.ok) throw new Error('API Error');
                    const data = await response.json();
                    if (data && data.data) {
                        RATES = data.data;
                        if (!RATES['USD']) RATES['USD'] = 1;
                        CURRENCY_CODES = Object.keys(RATES).sort();
                        USING_LIVE_RATES = true;
                        ui.showToast('Rates updated!');
                        window.app.refreshCurrencyDropdowns();
                        window.app.renderSettlement();
                        const label = document.getElementById('rates-source-label');
                        label.innerText = "Source: FreeCurrencyAPI (Live)";
                        label.classList.replace("text-slate-400", "text-green-600");
                    }
                } catch (error) {
                    console.error(error);
                    ui.showToast("Using offline rates.", 'error');
                }
            },
            renderSettlement: () => {
                const trip = localTrips.find(t => t.id === currentTripId);
                const planDiv = document.getElementById('settlement-plan');
                planDiv.innerHTML = '';
                // Filter out 'Personal' AND 'Settlement' types for debt calc (Settlements are payments, not new debts)
                // Actually, logic: 'Settlement' type expenses ARE processed by generateDebts to reduce balances.
                // But `e.notShared` should handle personal.
                // We want to process ALL expenses that affect balance.
                // Settlements have `isSettlement: true`. They affect balance.
                const expenses = localExpenses.filter(e => !e.notShared);
                if (expenses.length === 0) {
                    planDiv.innerHTML = '<div class="text-center py-8 text-slate-400">No shared expenses.</div>';
                    window.app.renderCharts([]);
                    return;
                }

                const generateDebts = (expList, targetCurr) => {
                    const balances = {};
                    trip.members.forEach(m => balances[m] = 0);
                    expList.forEach(exp => {
                        const val = state.consolidate ? util.convert(exp.amount, exp.currency, targetCurr) : exp.amount;
                        // Handle Splits
                        if (exp.splitType === 'exact' && exp.splitDetails) {
                            // Exact Amount Split
                            Object.entries(exp.splitDetails).forEach(([member, share]) => {
                                // Convert share if consolidated
                                const shareVal = state.consolidate ? util.convert(share, exp.currency, targetCurr) : share;
                                balances[member] -= shareVal;
                            });
                            balances[exp.payer] += val;
                        } else {
                            // Default Equal Split
                            const split = val / trip.members.length;
                            balances[exp.payer] += val;
                            trip.members.forEach(m => balances[m] -= split);
                        }
                    });
                    let debtors = [], creditors = [];
                    for (const [p, amt] of Object.entries(balances)) {
                        if (amt < -0.01) debtors.push({ p, amt });
                        if (amt > 0.01) creditors.push({ p, amt });
                    }
                    debtors.sort((a, b) => a.amt - b.amt);
                    creditors.sort((a, b) => b.amt - a.amt);
                    const debts = [];
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        let d = debtors[i], c = creditors[j];
                        let settleAmt = Math.min(Math.abs(d.amt), c.amt);
                        debts.push({ from: d.p, to: c.p, amt: settleAmt, curr: targetCurr });
                        d.amt += settleAmt; c.amt -= settleAmt;
                        if (Math.abs(d.amt) < 0.01) i++;
                        if (c.amt < 0.01) j++;
                    }
                    return debts;
                };

                let allDebts = [];
                if (state.consolidate) {
                    const targetCurr = document.getElementById('settle-currency-select').value || trip.currency;
                    allDebts = [...allDebts, ...generateDebts(expenses, targetCurr)];
                } else {
                    const distinctCurrencies = [...new Set(expenses.map(e => e.currency))];
                    distinctCurrencies.forEach(c => {
                        allDebts = [...allDebts, ...generateDebts(expenses.filter(e => e.currency === c), c)];
                    });
                }

                if (allDebts.length === 0) planDiv.innerHTML = '<div class="text-center text-green-600 font-bold p-4">All settled!</div>';
                // Sort by Amt
                allDebts.sort((a, b) => b.amt - a.amt);

                allDebts.forEach(d => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-xl border border-slate-200';
                    el.innerHTML = `
                            <div class="flex items-center gap-3 flex-1">
                                <div class="flex flex-col items-center gap-1 min-w-[3rem]">
                                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-xs font-bold text-indigo-700 border-2 border-white shadow-sm" title="${window.app.getDisplayName(d.from)}">
                                        ${window.app.getDisplayName(d.from).substring(0, 2).toUpperCase()}
                                    </div>
                                    <span class="text-[10px] text-slate-500 font-bold truncate max-w-[4rem]">${window.app.getDisplayName(d.from)}</span>
                                </div>
                                
                                <div class="flex flex-col items-center flex-1">
                                    <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Pays</span>
                                    <div class="h-[1px] w-full bg-slate-300 relative">
                                        <i class="fa-solid fa-chevron-right absolute -right-1 -top-2 text-slate-300"></i>
                                    </div>
                                    <span class="font-bold text-indigo-600 text-sm mt-1">${d.curr} ${d.amt.toFixed(2)}</span>
                                </div>

                                <div class="flex flex-col items-center gap-1 min-w-[3rem]">
                                    <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-xs font-bold text-emerald-700 border-2 border-white shadow-sm" title="${window.app.getDisplayName(d.to)}">
                                        ${window.app.getDisplayName(d.to).substring(0, 2).toUpperCase()}
                                    </div>
                                    <span class="text-[10px] text-slate-500 font-bold truncate max-w-[4rem]">${window.app.getDisplayName(d.to)}</span>
                                </div>
                            </div>
                            <div class="ml-4 pl-4 border-l border-slate-100">
                                <button onclick="window.app.openSettleModal('${d.from}', '${d.to}', ${d.amt}, '${d.curr}')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold px-4 py-2 rounded-lg shadow-sm shadow-indigo-200 transition active:scale-95">
                                    Settle
                                </button>
                            </div>
                        `;
                    planDiv.appendChild(el);
                });

                // Determine currency for charts
                const targetCurrency = state.consolidate ? (document.getElementById('settle-currency-select').value || trip.currency) : trip.currency;
                window.app.renderCharts(expenses.filter(e => !e.isSettlement), targetCurrency);
            },
            renderCharts: (expenses, targetCurrency) => {
                const catTotals = {}, payerTotals = {};
                expenses.forEach(e => {
                    // Use targetCurrency instead of hardcoded USD
                    const val = util.convert(e.amount, e.currency, targetCurrency);
                    catTotals[e.category] = (catTotals[e.category] || 0) + val;
                    payerTotals[e.payer] = (payerTotals[e.payer] || 0) + val;
                });
                const renderChart = (id, data, type) => {
                    if (charts[type]) charts[type].destroy();
                    const ctx = document.getElementById(id).getContext('2d');

                    // Render Chart
                    charts[type] = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(data),
                            datasets: [{ data: Object.values(data), backgroundColor: ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#94a3b8'], borderWidth: 0 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '70%' }
                    });

                    // Render Custom Legend/List
                    const legendId = id + '-legend';
                    let legendContainer = document.getElementById(legendId);

                    if (!legendContainer) {
                        legendContainer = document.createElement('div');
                        legendContainer.id = legendId;
                        legendContainer.className = 'mt-6 space-y-2'; // Removed max-h constraint, added more top margin
                        // Fix: Append to the card container (parent of the fixed height wrapper) to avoid cutoff
                        const chartWrapper = document.getElementById(id).parentNode;
                        chartWrapper.parentNode.appendChild(legendContainer);
                    }
                    legendContainer.innerHTML = '';

                    Object.entries(data).forEach(([key, val], idx) => {
                        const color = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa', '#94a3b8'][idx % 6];
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center text-xs';
                        // Resolve display name if type is payer
                        const label = type === 'payer' ? window.app.getDisplayName(key) : key;
                        div.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full" style="background-color: ${color}"></span>
                                <span class="text-slate-600 font-medium truncate w-24">${label}</span>
                            </div>
                            <span class="font-bold text-slate-800">${targetCurrency} ${val.toFixed(2)}</span>
                         `;
                        legendContainer.appendChild(div);
                    });
                };
                renderChart('chart-categories', catTotals, 'cat');
                renderChart('chart-payers', payerTotals, 'payer');
            },

            // --- UI HELPERS ---
            openModal: (id) => {
                try {
                    const modal = document.getElementById(id);
                    if (modal) modal.classList.remove('hidden');

                    // Run setup logic in next tick to avoid blocking render
                    setTimeout(() => {
                        try {
                            if (id === 'modal-add-expense') window.app.prepareAddExpenseModal();
                            if (id === 'modal-new-trip') window.app.prepareNewTripModal();
                            if (id === 'modal-members') window.app.renderManageMembers();
                            if (id === 'modal-settings') {
                                const input = document.getElementById('setting-display-name');
                                if (input) {
                                    const currentName = (userProfiles && currentUser && userProfiles[currentUser]) || '';
                                    input.value = currentName;
                                }
                            }
                        } catch (innerError) {
                            console.error("Modal Setup Error:", innerError);
                            ui.showToast("Error loading modal details", 'error');
                        }
                    }, 0);
                } catch (error) {
                    console.error("OpenModal Error:", error);
                }
            },

            closeModals: () => {
                document.querySelectorAll('[id^="modal-"]').forEach(el => el.classList.add('hidden'));
                editingExpenseId = null;
                editingTripId = null;
                editingSettlementId = null;
            },
            switchTab: (tab) => {
                document.getElementById('tab-expenses').classList.add('hidden');
                document.getElementById('tab-settle').classList.add('hidden');
                document.getElementById('tab-history').classList.add('hidden');

                document.getElementById('tab-btn-expenses').className = "px-6 py-3 font-medium text-sm border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition";
                document.getElementById('tab-btn-settle').className = "px-6 py-3 font-medium text-sm border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition";
                document.getElementById('tab-btn-history').className = "px-6 py-3 font-medium text-sm border-b-2 border-transparent text-slate-400 hover:text-slate-600 transition";

                document.getElementById('tab-' + tab).classList.remove('hidden');
                document.getElementById('tab-btn-' + tab).className = "px-6 py-3 font-medium text-sm border-b-2 border-indigo-600 text-indigo-600 transition";

                // Re-render based on tab
                if (tab === 'settle') window.app.renderSettlement();
                if (tab === 'history') window.app.renderHistory();
            },
            prepareAddExpenseModal: () => {
                if (!currentTripId) return; // Guard
                const trip = localTrips.find(t => t.id === currentTripId);
                if (!trip) return;

                const title = document.getElementById('expense-modal-title');
                const btn = document.getElementById('expense-modal-btn');

                // Reset Split UI
                document.getElementById('split-options').classList.add('hidden');
                document.getElementById('exp-not-shared').checked = false;
                window.app.setSplitType('equal');
                // removed toggleSplitUI call since setSplitType handles it

                const payerSelect = document.getElementById('exp-payer');
                payerSelect.innerHTML = '';
                trip.members.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.text = window.app.getDisplayName(m);
                    payerSelect.add(opt);
                });

                // Populate Split Members (hidden init)
                window.app.renderSplitMembers();

                // Currency
                const currencySelect = document.getElementById('exp-currency');
                currencySelect.innerHTML = '';
                [trip.currency, ...CURRENCY_CODES.filter(c => c !== trip.currency)].forEach(c => currencySelect.add(new Option(c, c)));
                // Just ensuring default is set if new
                if (!editingExpenseId) currencySelect.value = trip.currency;
                else {
                    // Edit mode special handling for split (complex to re-hydrate, skipping deep re-hydration of exact split inputs for MVP simplicity or doing basic)
                    // For now, if editing, we load basic data. Split data loading would require storing it first.
                    // IMPLEMENTATION NOTE: Loading existing split details is tricky without `splitDetails` in `exp`. 
                    // Assuming `exp` object structure update in saveExpense first.
                    const exp = localExpenses.find(e => e.id === editingExpenseId);
                    if (exp && exp.splitDetails) {
                        if (exp.splitType !== 'equal') {
                            document.getElementById('split-options').classList.remove('hidden');
                            window.app.setSplitType(exp.splitType);
                            // We need to wait for renderSplitMembers to finish? It is sync.
                            // Populate inputs
                            setTimeout(() => {
                                document.querySelectorAll('.split-input').forEach(inp => {
                                    const m = inp.dataset.member;
                                    if (exp.splitDetails[m]) inp.value = exp.splitDetails[m];
                                });
                            }, 0);
                        }
                    }
                }

                const catGrid = document.getElementById('category-grid');
                catGrid.innerHTML = '';
                CATEGORIES.forEach(cat => {
                    const b = document.createElement('button');
                    b.className = `p-2 rounded-xl border flex flex-col items-center gap-1 transition border-slate-200 hover:bg-slate-50`;
                    b.innerHTML = `<div class="w-8 h-8 rounded-full ${cat.color} flex items-center justify-center text-sm"><i class="fa-solid ${cat.icon}"></i></div><span class="text-[10px] font-bold text-slate-600 uppercase">${cat.id}</span>`;
                    b.onclick = () => {
                        document.querySelectorAll('#category-grid button').forEach(bt => bt.className = bt.className.replace('border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500', 'border-slate-200 hover:bg-slate-50'));
                        b.className = b.className.replace('border-slate-200 hover:bg-slate-50', 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500');
                        document.getElementById('exp-category').value = cat.id;
                    };
                    catGrid.appendChild(b);
                });

                if (editingExpenseId) {
                    const exp = localExpenses.find(e => e.id === editingExpenseId);
                    title.innerText = "Edit Expense";
                    btn.innerText = "Update Expense";
                    document.getElementById('exp-desc').value = exp.desc;
                    document.getElementById('exp-amount').value = exp.amount;
                    document.getElementById('exp-currency').value = exp.currency;
                    document.getElementById('exp-payer').value = exp.payer;
                    document.getElementById('exp-category').value = exp.category;
                    document.getElementById('exp-not-shared').checked = exp.notShared;
                    if (exp.notShared) {
                        document.getElementById('split-options').classList.remove('hidden'); // Show options so tab is visible
                        window.app.setSplitType('personal');
                    }
                    // Auto-select category visual
                    const index = CATEGORIES.findIndex(c => c.id === exp.category);
                    if (index > -1 && catGrid.children[index]) catGrid.children[index].click();
                } else {
                    title.innerText = "Add Expense";
                    btn.innerText = "Save Expense";
                    document.getElementById('exp-desc').value = '';
                    document.getElementById('exp-amount').value = '';
                    document.getElementById('exp-not-shared').checked = false;
                    if (catGrid.firstChild) catGrid.firstChild.click();
                }
            },
            openCreateTripModal: (tripId = null) => {
                editingTripId = tripId;
                const title = document.getElementById('create-trip-title');
                const btn = document.getElementById('create-trip-btn');
                const nameIn = document.getElementById('new-trip-name');
                const currIn = document.getElementById('new-trip-currency');
                const memIn = document.getElementById('new-trip-members');

                // Reset or Prefill
                if (tripId) {
                    const trip = localTrips.find(t => t.id === tripId);
                    if (!trip) return;
                    title.innerText = "Edit Trip";
                    btn.innerText = "Save Changes";
                    nameIn.value = trip.name;
                    currIn.value = trip.currency;
                    memIn.value = trip.members.join(', ');
                } else {
                    title.innerText = "Start New Trip";
                    btn.innerText = "Create Trip";
                    nameIn.value = '';
                    currIn.value = 'MYR'; // Default
                    memIn.value = '';
                }
                window.app.openModal('modal-create-trip');
            },

            // toggleSplitUI removed, merged into setSplitType
            setSplitType: (type) => {
                currentSplitType = type;

                // Update Tabs
                const baseClass = "flex-1 py-1.5 text-xs font-bold rounded transition ";
                const activeClass = "bg-indigo-100 text-indigo-700";
                const inactiveClass = "text-slate-500 hover:bg-slate-50";

                document.getElementById('btn-split-equal').className = baseClass + (type === 'equal' ? activeClass : inactiveClass);
                document.getElementById('btn-split-exact').className = baseClass + (type === 'exact' ? activeClass : inactiveClass);
                document.getElementById('btn-split-personal').className = baseClass + (type === 'personal' ? activeClass : inactiveClass);

                const container = document.getElementById('split-logic-container');
                const personalMsg = document.getElementById('personal-mode-msg');
                const checkbox = document.getElementById('exp-not-shared');

                if (type === 'personal') {
                    container.classList.add('hidden');
                    personalMsg.classList.remove('hidden');
                    checkbox.checked = true;
                } else {
                    container.classList.remove('hidden');
                    personalMsg.classList.add('hidden');
                    checkbox.checked = false;
                    window.app.renderSplitMembers();
                }
            },
            renderSplitMembers: () => {
                const list = document.getElementById('split-members-list');
                list.innerHTML = '';
                if (currentSplitType === 'equal') {
                    list.innerHTML = '<p class="text-xs text-slate-400 text-center italic">Split equally among all members.</p>';
                    return;
                }
                const trip = localTrips.find(t => t.id === currentTripId);
                const currency = document.getElementById('exp-currency').value;
                trip.members.forEach(m => {
                    const row = document.createElement('div');
                    row.className = 'flex items-center justify-between text-xs';
                    row.innerHTML = `
                        <span class="text-slate-600 truncate w-24">${window.app.getDisplayName(m)}</span>
                        <div class="flex items-center gap-1 flex-1 justify-end">
                            <span class="text-slate-400 text-xs">${currency}</span>
                            <input type="number" step="0.01" class="split-input w-full max-w-[8rem] border rounded-lg px-2 py-2 text-right outline-none focus:border-indigo-500 text-base font-bold text-slate-700 bg-slate-50 focus:bg-white transition" placeholder="0.00" data-member="${m}">
                        </div>
                    `;
                    list.appendChild(row);
                });
            },
            editExpense: (id) => {
                editingExpenseId = id;
                window.app.openModal('modal-add-expense');
            }
        };

        const util = {
            convert: (amount, from, to) => {
                if (from === to) return amount;
                const inUSD = amount / (RATES[from] || 1);
                return inUSD * (RATES[to] || 1);
            }
        };

        const ui = {
            showToast: (msg, type = 'success') => {
                const container = document.getElementById('toast-container');
                const div = document.createElement('div');
                div.className = `p-4 rounded-xl shadow-xl mb-3 text-white text-sm font-bold flex items-center gap-3 slide-in border border-white/10 backdrop-blur-md ${type === 'error' ? 'bg-red-500/90' : (type === 'info' ? 'bg-indigo-600/90' : 'bg-slate-800/90')}`;
                div.innerHTML = `<i class="fa-solid ${type === 'error' ? 'fa-circle-exclamation' : 'fa-check-circle'} text-lg"></i> <span>${msg}</span>`;
                container.appendChild(div);
                setTimeout(() => { div.style.opacity = '0'; setTimeout(() => div.remove(), 300) }, 3000);
            }
        };

        // BIND BUTTONS
        document.getElementById('btn-login').onclick = window.app.login;
        document.getElementById('btn-logout').onclick = window.app.logout;
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768 && currentUser && !document.getElementById('view-trip').classList.contains('hidden')) {
                document.getElementById('view-dashboard').classList.remove('hidden');
            }
        });
    </script>
</body>

</html>